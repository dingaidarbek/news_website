<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>–ù–æ–≤–æ—Å—Ç–∏</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.min.js"></script>
    <style>
        #loader {
            display: none;
            font-weight: bold;
            color: gray;
        }
        body{
        }
        .article:hover{
            background-color:  lightgrey;
            transition: all 0.3s;
        }
        button {
            display: inline;
        }
    </style>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.css">
</head>
<body>
<div class = "ui container">
    <div id="categoryButtons" class = "ui menu tabular">
        <button class="category-btn ui button item active" data-category="general">Home</button>
        <button class="category-btn ui button item" data-category="business">Business News</button>
        <button class="category-btn ui button item" data-category="entertainment">Entertainment News</button>
        <button class="category-btn ui button item" data-category="health">Health News</button>
        <button class="category-btn ui button item" data-category="science">Science News</button>
        <button class="category-btn ui button item" data-category="sports">Sports News</button>
        <button class="category-btn ui button item" data-category="technology">Technology News</button>
        <button class="ui right item primary button" id="openModalBtn" style="background-color:lightblue">Morning digest</button>
    </div>

    <div class="ui modal" id="newsModal">
        <i class="close icon"></i>
        <div class="header">Morning digest</div>
        <div class="scrolling content">
            <div id="newsContent" class="ui relaxed divided list">
                <div class="item">Loading news...</div>
            </div>
        </div>
        <div class="actions">
            <div class="ui approve button">Close</div>
        </div>
    </div>
    <script>
        $('#openModalBtn').on('click', function () {
            // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª
            $('#newsModal').modal('show');

            // –û—á–∏—Å—Ç–∏—Ç—å –∏ –ø–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
            $('#newsContent').html('<div class="item">Loading news...</div>');

            // –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ —Å backend
            fetch('/api/digest')
                    .then(response => response.text())
                    .then(data => {
                        try {
                            const json = JSON.parse(data);
                            if (json.articles && json.articles.length > 0) {
                                const fetchSummarizedArticles = async () => {
                                    const summaries = await Promise.all(json.articles.map(async article => {
                                        try {
                                            const response = await fetch('https://news-summarizer-h2y3.onrender.com/summarize', {
                                                method: 'POST',
                                                headers: {'Content-Type': 'application/json'},
                                                body: JSON.stringify({url: article.url})
                                            });
                                            const result = await response.json();
                                            const summaryText = result.summary || 'No summary available.';
                                            return `
                                            <div class="item">
                                              <div class="content">
                                                <a class="header" href="${article.url}" target="_blank">${article.title}</a>
                                                <div class="description">${article.description || ''}</div>
                                                <div class="ui segment">${summaryText}</div>
                                              </div>
                                            </div>
                                          `;
                                        } catch (err) {
                                            return `
                                            <div class="item">
                                              <div class="content">
                                                <a class="header" href="${article.url}" target="_blank">${article.title}</a>
                                                <div class="description">${article.description || ''}</div>
                                                <div class="ui segment">‚ùå Failed to summarize article.</div>
                                              </div>
                                            </div>
                                          `;
                                        }
                                    }));

                                    $('#newsContent').html(summaries.join(''));
                                };
                                fetchSummarizedArticles();

                            } else {
                                $('#newsContent').html('<div class="item">No news</div>');
                            }
                        } catch (e) {
                            $('#newsContent').html('<div class="item">Something wrong happened... (Error code: 1)</div>');
                        }
                    })
                    .catch(() => {
                        $('#newsContent').html('<div class="item">Something wrong happened... (Error code: 2)</div>');
                    });
        });
    </script>




    <div id="loader">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</div>
    <div id="news-container" class = "ui two column doubling stackable grid container"></div>

    <script>
        function fetchNews(categories){
            $('#loader').show();

            $.ajax({
                url: '/api/news/categories',
                method: 'GET',
                data: {categories: categories || 'general'},
                success: function (data) {
                    const html = data.data.map(a => {
                        const imageUrl = a.image || 'https://upload.wikimedia.org/wikipedia/commons/a/ac/No_image_available.svg'; // –¥–µ—Ñ–æ–ª—Ç–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞

                        return `
                        <a href="${a.url}" target="_blank" style="text-decoration: none; color: inherit;" class = "column">
                          <div style="border:1px solid black; padding: 10px; margin-bottom: 10px; cursor: pointer;" class = "article">
                            <h1>${a.title}</h1>
                            <img src="${imageUrl}" style="width:100px; height:100px;" alt="news image">
                            <p>${a.description}</p>
                          </div>
                        </a>
                      `;
                    }).join('');

                    $('#news-container').html(html);
                },
                error: function () {
                    $('#news-container').html('<p>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ—Å—Ç–µ–π.</p>');
                },
                complete: function () {
                    $('#loader').hide();
                }
            });
        }
        $(document).ready(function(){
            // ‚¨áÔ∏è –°—á–∏—Ç—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ 'general'
            const savedCategory = localStorage.getItem('preferredCategory') || 'general';
            if (savedCategory) {
                // –£–¥–∞–ª—è–µ–º active —É –≤—Å–µ—Ö –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é
                $(`.category-btn`).removeClass('active');
                // –î–æ–±–∞–≤–ª—è–µ–º active –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º—É
                $(`.category-btn[data-category="${savedCategory}"]`).addClass('active');
            }

            // ‚¨áÔ∏è –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –Ω–æ–≤–æ—Å—Ç–∏
            fetchNews(savedCategory);

            $('#categoryButtons').on('click', '.category-btn', function (e) {
                e.preventDefault(); // —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
                // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å 'selected' —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                $('.category-btn').removeClass('active');

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å 'selected' —Ç–æ–ª—å–∫–æ –Ω–∞ –Ω–∞–∂–∞—Ç—É—é –∫–Ω–æ–ø–∫—É
                $(this).addClass('active');
                const category = $(this).data('category') || 'general';

                // ‚¨áÔ∏è –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤ localStorage
                localStorage.setItem('preferredCategory', category);

                fetchNews(category);
            });
        });
    </script>
</div>
</body>
</html>
